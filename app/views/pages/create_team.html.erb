<!-- Create Team Page -->
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-red-900 to-black">
  <%= render 'shared/header' %>

  <!-- Main Content -->
  <div class="w-full px-4 py-12">
    <!-- Header Section -->
    <div class="text-center mb-12">
      <div class="flex items-center justify-between max-w-7xl mx-auto mb-4">
        <a href="/dashboard" class="text-2xl font-bold text-white bg-gradient-to-r from-red-600 to-red-700 px-6 py-3 rounded-lg hover:from-red-700 hover:to-red-800 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl">
          Fantasy F1 League
        </a>
        <h1 class="text-5xl font-bold text-white flex-1 text-center">üèéÔ∏è Create My Team</h1>
        <div class="w-64"></div>
      </div>
    </div>

    <!-- Team Rules -->
    <div class="max-w-4xl mx-auto mb-8">
      <div class="bg-gradient-to-br from-blue-800 to-blue-900 p-6 rounded-2xl border border-blue-600">
        <h2 class="text-2xl font-bold text-white mb-4">üìã Team Rules</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
          <div class="flex items-center space-x-2">
            <span class="text-green-400">‚úì</span>
            <span>Select exactly 2 drivers</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">‚úì</span>
            <span>Select exactly 1 constructor</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">‚úì</span>
            <span>Stay within $<%= @total_budget %>M budget</span>
          </div>
          <div class="flex items-center space-x-2">
            <span class="text-green-400">‚úì</span>
            <span>Drivers sorted by price (highest first)</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Selection Form -->
    <%= form_with url: "/create-team", method: :post, local: true, id: "team-form" do |form| %>
      
      <!-- Hidden fields for form submission -->
      <%= form.hidden_field :drivers, id: "drivers-field" %>
      <%= form.hidden_field :constructor, id: "constructor-field" %>
      
      <div data-react-component="TeamBuilder"></div>
      
      <!-- Submit Button -->
      <div class="text-center mt-8">
        <%= form.submit "Create Team", id: "submit-team", class: "bg-gradient-to-r from-red-600 to-red-700 text-white text-xl font-bold px-8 py-4 rounded-lg hover:from-red-700 hover:to-red-800 transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed" %>
      </div>
    <% end %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  let selectedDrivers = [];
  let selectedConstructor = null;
  let totalCost = 0;
  const budget = <%= @total_budget %>;

  // Driver selection
  document.querySelectorAll('.select-driver-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const card = this.closest('.driver-card');
      const checkbox = card.querySelector('.driver-checkbox');
      const price = parseInt(card.dataset.price);
      const driverId = card.dataset.driverId;
      const driverName = card.querySelector('h3').textContent;

      if (checkbox.checked) {
        // Deselect
        checkbox.checked = false;
        selectedDrivers = selectedDrivers.filter(d => d.id !== driverId);
        totalCost -= price;
        this.textContent = 'Select';
        card.classList.remove('bg-red-800', 'bg-red-900');
        card.classList.add('hover:bg-gray-700');
      } else {
        // Select (if under limit)
        if (selectedDrivers.length < 2) {
          checkbox.checked = true;
          selectedDrivers.push({ id: driverId, name: driverName, price: price });
          totalCost += price;
          this.textContent = 'Selected ‚úì';
          card.classList.remove('hover:bg-gray-700');
          card.classList.add('bg-red-800', 'bg-red-900');
        } else {
          alert('You can only select 2 drivers!');
          return;
        }
      }
      updateBudget();
      updateTeamPreview();
      updateSubmitButton();
    });
  });

  // Constructor selection
  document.querySelectorAll('.select-constructor-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const card = this.closest('.constructor-card');
      const radio = card.querySelector('.constructor-radio');
      const price = parseInt(card.dataset.price);
      const constructorId = card.dataset.constructorId;
      const constructorName = card.querySelector('h3').textContent;

      // Deselect all constructors first
      document.querySelectorAll('.constructor-radio').forEach(r => r.checked = false);
      document.querySelectorAll('.select-constructor-btn').forEach(b => b.textContent = 'Select');
      document.querySelectorAll('.constructor-card').forEach(c => {
        c.classList.remove('bg-red-800', 'bg-red-900');
        c.classList.add('hover:bg-gray-700');
      });

      // Select this constructor
      radio.checked = true;
      selectedConstructor = { id: constructorId, name: constructorName, price: price };
      this.textContent = 'Selected ‚úì';
      card.classList.remove('hover:bg-gray-700');
      card.classList.add('bg-red-800', 'bg-red-900');

      updateBudget();
      updateTeamPreview();
      updateSubmitButton();
    });
  });

  function updateBudget() {
    const remaining = budget - totalCost;
    document.getElementById('total-cost').textContent = `$${totalCost}M`;
    document.getElementById('remaining-budget').textContent = `$${remaining}M`;
    
    // Color coding
    const remainingEl = document.getElementById('remaining-budget');
    if (remaining < 0) {
      remainingEl.className = 'text-3xl font-bold text-red-400';
    } else if (remaining < 10) {
      remainingEl.className = 'text-3xl font-bold text-yellow-400';
    } else {
      remainingEl.className = 'text-3xl font-bold text-blue-400';
    }
  }

  function updateTeamPreview() {
    const teamDiv = document.getElementById('selected-team');
    let html = '';

    if (selectedDrivers.length > 0 || selectedConstructor) {
      html += '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
      
      if (selectedDrivers.length > 0) {
        html += '<div><h3 class="text-lg font-bold text-white mb-3">üë§ Drivers:</h3><ul class="space-y-2">';
        selectedDrivers.forEach(driver => {
          html += `<li class="text-gray-300">‚Ä¢ ${driver.name} - $${driver.price}M</li>`;
        });
        html += '</ul></div>';
      }

      if (selectedConstructor) {
        html += '<div><h3 class="text-lg font-bold text-white mb-3">üè≠ Constructor:</h3>';
        html += `<p class="text-gray-300">‚Ä¢ ${selectedConstructor.name} - $${selectedConstructor.price}M</p></div>`;
      }

      html += '</div>';
    } else {
      html = '<p class="text-center text-gray-400">Select your drivers and constructor to see your team preview</p>';
    }

    teamDiv.innerHTML = html;
  }

  function updateSubmitButton() {
    const submitBtn = document.getElementById('submit-team');
    const isValid = selectedDrivers.length === 2 && selectedConstructor && totalCost <= budget;
    
    submitBtn.disabled = !isValid;
    
    if (isValid) {
      submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
      submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
  }

  // Form submission handling
  document.getElementById('team-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate selections
    if (selectedDrivers.length !== 2) {
      alert('Please select exactly 2 drivers!');
      return;
    }
    
    if (!selectedConstructor) {
      alert('Please select exactly 1 constructor!');
      return;
    }
    
    if (totalCost > budget) {
      alert('Team cost exceeds budget!');
      return;
    }
    
    // Populate hidden fields
    document.getElementById('drivers-field').value = selectedDrivers.map(d => d.id).join(',');
    document.getElementById('constructor-field').value = selectedConstructor.id;
    
    // Submit the form
    this.submit();
  });

});
</script> 